# Ví dụ: Tạo Chat Gateway

File này hướng dẫn cách tạo Chat Gateway sử dụng WebSocket Common Module.

## Bước 1: Tạo Chat Entity (nếu chưa có)

```typescript
// entities/chat-message.entity.ts
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, ManyToOne, JoinColumn } from 'typeorm';
import { User } from './user.entity';

@Entity('chat_messages')
export class ChatMessage {
  @PrimaryGeneratedColumn({ type: 'bigint' })
  id: number;

  @Column({ name: 'sender_id', type: 'bigint' })
  sender_id: number;

  @Column({ name: 'receiver_id', type: 'bigint' })
  receiver_id: number;

  @Column({ name: 'message', type: 'text' })
  message: string;

  @Column({ name: 'is_read', type: 'boolean', default: false })
  is_read: boolean;

  @CreateDateColumn({ name: 'created_at' })
  created_at: Date;

  @ManyToOne(() => User)
  @JoinColumn({ name: 'sender_id' })
  sender: User;

  @ManyToOne(() => User)
  @JoinColumn({ name: 'receiver_id' })
  receiver: User;
}
```

## Bước 2: Tạo Chat Service

```typescript
// modules/chat/chat.service.ts
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { ChatMessage } from '../../entities/chat-message.entity';
import { ChatGateway } from './chat.gateway';

@Injectable()
export class ChatService {
  constructor(
    @InjectRepository(ChatMessage)
    private chatMessageRepository: Repository<ChatMessage>,
    private chatGateway: ChatGateway,
  ) {}

  async sendMessage(senderId: number, receiverId: number, message: string): Promise<ChatMessage> {
    const chatMessage = this.chatMessageRepository.create({
      sender_id: senderId,
      receiver_id: receiverId,
      message,
      is_read: false,
    });

    const savedMessage = await this.chatMessageRepository.save(chatMessage);

    // Emit message qua WebSocket
    this.chatGateway.emitMessageToUser(receiverId, savedMessage);

    return savedMessage;
  }

  async getMessages(userId: number, otherUserId: number): Promise<ChatMessage[]> {
    return await this.chatMessageRepository.find({
      where: [
        { sender_id: userId, receiver_id: otherUserId },
        { sender_id: otherUserId, receiver_id: userId },
      ],
      relations: ['sender', 'receiver'],
      order: { created_at: 'ASC' },
    });
  }
}
```

## Bước 3: Tạo Chat Gateway

```typescript
// modules/chat/chat.gateway.ts
import { WebSocketGateway, SubscribeMessage, ConnectedSocket, MessageBody } from '@nestjs/websockets';
import { Socket } from 'socket.io';
import { UseGuards } from '@nestjs/common';
import { BaseGateway, ConnectionManagerService, WsJwtGuard } from '../../common/websocket';
import { ChatService } from './chat.service';

@WebSocketGateway({
  cors: { origin: '*', credentials: true },
  namespace: '/chat',
})
export class ChatGateway extends BaseGateway {
  protected readonly namespace = '/chat';

  constructor(
    connectionManager: ConnectionManagerService,
    wsJwtGuard: WsJwtGuard,
    private readonly chatService: ChatService,
  ) {
    super(connectionManager, wsJwtGuard);
  }

  /**
   * Override onUserConnected để join user vào room của chính họ
   */
  protected async onUserConnected(client: Socket, user: any): Promise<void> {
    await super.onUserConnected(client, user);
    
    // Join user vào room của chính họ để có thể nhận message
    client.join(`user_${user.id}`);
    this.logger.log(`User ${user.id} joined chat room`);
  }

  /**
   * Emit message đến user cụ thể
   */
  emitMessageToUser(userId: number, message: any): void {
    // Emit đến room của user
    this.emitToRoom(`user_${userId}`, 'new_message', message);
    
    // Hoặc emit trực tiếp đến user
    // this.emitToUser(userId, 'new_message', message);
  }

  /**
   * Client gửi message
   */
  @UseGuards(WsJwtGuard)
  @SubscribeMessage('send_message')
  async handleSendMessage(
    @ConnectedSocket() client: Socket,
    @MessageBody() data: { receiverId: number; message: string },
  ) {
    const user = client.data.user;
    
    try {
      const chatMessage = await this.chatService.sendMessage(
        user.id,
        data.receiverId,
        data.message,
      );

      // Gửi lại cho sender để confirm
      client.emit('message_sent', chatMessage);

      return { success: true, data: chatMessage };
    } catch (error) {
      this.logger.error(`Error sending message: ${error.message}`);
      return { success: false, error: error.message };
    }
  }

  /**
   * Client yêu cầu lấy messages với user khác
   */
  @UseGuards(WsJwtGuard)
  @SubscribeMessage('get_messages')
  async handleGetMessages(
    @ConnectedSocket() client: Socket,
    @MessageBody() data: { otherUserId: number },
  ) {
    const user = client.data.user;
    
    try {
      const messages = await this.chatService.getMessages(user.id, data.otherUserId);
      client.emit('messages', messages);
      return { success: true, data: messages };
    } catch (error) {
      this.logger.error(`Error getting messages: ${error.message}`);
      return { success: false, error: error.message };
    }
  }

  /**
   * Client yêu cầu danh sách users online
   */
  @UseGuards(WsJwtGuard)
  @SubscribeMessage('get_online_users')
  handleGetOnlineUsers(@ConnectedSocket() client: Socket) {
    const onlineUsers = this.connectionManager.getOnlineUsers();
    client.emit('online_users', onlineUsers);
    return { success: true, data: onlineUsers };
  }
}
```

## Bước 4: Tạo Chat Module

```typescript
// modules/chat/chat.module.ts
import { Module, forwardRef } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ChatController } from './chat.controller';
import { ChatService } from './chat.service';
import { ChatGateway } from './chat.gateway';
import { ChatMessage } from '../../entities/chat-message.entity';
import { WebSocketModule } from '../../common/websocket';

@Module({
  imports: [
    TypeOrmModule.forFeature([ChatMessage]),
    WebSocketModule, // Import shared WebSocket module
  ],
  controllers: [ChatController],
  providers: [ChatService, ChatGateway],
  exports: [ChatService],
})
export class ChatModule {}
```

## Bước 5: Thêm vào AppModule

```typescript
// app.module.ts
import { ChatModule } from './modules/chat/chat.module';

@Module({
  imports: [
    // ... other modules
    WebSocketModule, // Đã có rồi
    ChatModule,
  ],
})
export class AppModule {}
```

## Client Code (React/Vue/Angular)

```javascript
import { io } from 'socket.io-client';

// Kết nối chat WebSocket
const chatSocket = io('http://localhost:3000/chat', {
  auth: { token: 'your-jwt-token' }
});

// Lắng nghe message mới
chatSocket.on('new_message', (message) => {
  console.log('New message:', message);
  // Hiển thị message trong UI
});

// Gửi message
chatSocket.emit('send_message', {
  receiverId: 123,
  message: 'Hello!'
});

// Lấy messages với user khác
chatSocket.emit('get_messages', { otherUserId: 123 });

// Lắng nghe response
chatSocket.on('messages', (messages) => {
  console.log('Messages:', messages);
});

// Lấy danh sách users online
chatSocket.emit('get_online_users');
chatSocket.on('online_users', (users) => {
  console.log('Online users:', users);
});
```

## Lợi ích của việc sử dụng Shared Module

1. **Tái sử dụng code**: Không cần implement lại JWT auth, connection management
2. **Consistency**: Tất cả gateway dùng chung cách authenticate và quản lý connections
3. **Dễ maintain**: Chỉ cần sửa một chỗ cho tất cả gateway
4. **Connection Manager**: Có thể kiểm tra user online từ bất kỳ module nào
5. **Base Gateway**: Cung cấp các helper methods sẵn có

## Tips

- Sử dụng `rooms` cho group chat hoặc private chat
- Sử dụng `emitToUser()` cho 1-1 messages
- Sử dụng `emitToRoom()` cho group messages
- Kiểm tra user online trước khi gửi message: `connectionManager.isUserOnline(userId)`

