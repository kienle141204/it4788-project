# WebSocket Common Module

Module WebSocket dùng chung cho toàn bộ ứng dụng. Module này cung cấp các service và base class để các module khác (notifications, chat, etc.) có thể tái sử dụng.

## Cấu trúc

```
common/websocket/
├── websocket.module.ts          # Module chính (Global)
├── connection-manager.service.ts # Quản lý tất cả WebSocket connections
├── base.gateway.ts              # Base class để các gateway extend
├── guards/
│   └── ws-jwt.guard.ts         # JWT authentication guard cho WebSocket
└── index.ts                     # Export tất cả
```

## Các thành phần

### 1. ConnectionManagerService
Service quản lý tất cả WebSocket connections:
- `addConnection(userId, socketId)`: Thêm connection
- `removeConnection(socketId)`: Xóa connection
- `getUserSockets(userId)`: Lấy tất cả sockets của user
- `isUserOnline(userId)`: Kiểm tra user có online không
- `getOnlineUsers()`: Lấy danh sách users đang online

### 2. WsJwtGuard
JWT authentication guard cho WebSocket:
- Tự động extract token từ query, auth object, hoặc Authorization header
- Verify JWT token và gắn user info vào `client.data.user`

### 3. BaseGateway
Base class để các gateway extend:
- Tự động xử lý connection/disconnection
- JWT authentication
- Connection management
- Các helper methods: `emitToUser()`, `emitToAll()`, `emitToRoom()`

## Cách sử dụng

### Ví dụ 1: Notifications Gateway (đã implement)

```typescript
import { WebSocketGateway, SubscribeMessage, ConnectedSocket } from '@nestjs/websockets';
import { Socket } from 'socket.io';
import { UseGuards } from '@nestjs/common';
import { BaseGateway, ConnectionManagerService, WsJwtGuard } from '../../common/websocket';
import { NotificationsService } from './notifications.service';

@WebSocketGateway({
  cors: { origin: '*', credentials: true },
  namespace: '/notifications',
})
export class NotificationsGateway extends BaseGateway {
  protected readonly namespace = '/notifications';

  constructor(
    connectionManager: ConnectionManagerService,
    wsJwtGuard: WsJwtGuard,
    private readonly notificationsService: NotificationsService,
  ) {
    super(connectionManager, wsJwtGuard);
  }

  // Override để thêm logic riêng khi user kết nối
  protected async onUserConnected(client: Socket, user: any): Promise<void> {
    await super.onUserConnected(client, user);
    // Logic riêng của notifications...
  }

  // Emit thông báo đến user
  emitNotificationToUser(userId: number, notification: any): void {
    this.emitToUser(userId, 'new_notification', notification);
  }
}
```

### Ví dụ 2: Chat Gateway (cho người sau implement)

Xem file `CHAT_EXAMPLE.md` để xem ví dụ chi tiết.

## Import vào Module

```typescript
import { Module } from '@nestjs/common';
import { WebSocketModule } from '../../common/websocket';
import { YourGateway } from './your.gateway';

@Module({
  imports: [WebSocketModule], // Import shared WebSocket module
  providers: [YourGateway],
})
export class YourModule {}
```

## Lưu ý

1. **WebSocketModule là Global**: Chỉ cần import một lần trong `AppModule`, các module khác có thể inject trực tiếp.

2. **ConnectionManagerService**: Tất cả gateway dùng chung một instance, nên có thể kiểm tra user online từ bất kỳ module nào.

3. **JWT Token**: Client có thể gửi token qua:
   - Query parameter: `?token=xxx`
   - Auth object: `auth: { token: 'xxx' }`
   - Authorization header: `Authorization: Bearer xxx`

4. **Namespace**: Mỗi gateway nên có namespace riêng để tránh conflict.

